rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description: Secures the root-level 'condominiums' collection. Only authenticated admins can read and write condominium details.
     * @path: /condominiums/{condominiumId}
     * @allow: User with admin role (get), User with admin role (create)
     * @deny: Unauthenticated user (get), User without admin role (create)
     * @principle: Enforces role-based access control for condominium data.
     */
    match /condominiums/{condominiumId} {
      // Allow reads for authenticated users who are admins for this condominium.
      allow get: if isSignedIn() && isAdmin(condominiumId);
      allow list: if isSignedIn() && isAdmin(condominiumId);

      // Allow creation, updates, and deletes only for authenticated users who are admins for this condominium.
      allow create: if isSignedIn() && isAdmin(condominiumId);
      allow update: if isSignedIn() && isAdmin(condominiumId);
      allow delete: if isSignedIn() && isAdmin(condominiumId);

      match /units/{unitId} {
          allow get: if isSignedIn() && isAdmin(condominiumId);
          allow list: if isSignedIn() && isAdmin(condominiumId);
          allow create: if isSignedIn() && isAdmin(condominiumId);
          allow update: if isSignedIn() && isAdmin(condominiumId);
          allow delete: if isSignedIn() && isAdmin(condominiumId);
      }

      match /financial_transactions/{transactionId} {
          allow get: if isSignedIn() && isAdmin(condominiumId);
          allow list: if isSignedIn() && isAdmin(condominiumId);
          allow create: if isSignedIn() && isAdmin(condominiumId);
          allow update: if isSignedIn() && isAdmin(condominiumId);
          allow delete: if isSignedIn() && isAdmin(condominiumId);
      }

      match /accounts_receivable/{accountReceivableId} {
          allow get: if isSignedIn() && isAdmin(condominiumId);
          allow list: if isSignedIn() && isAdmin(condominiumId);
          allow create: if isSignedIn() && isAdmin(condominiumId);
          allow update: if isSignedIn() && isAdmin(condominiumId);
          allow delete: if isSignedIn() && isAdmin(condominiumId);
      }

      match /accounts_payable/{accountPayableId} {
          allow get: if isSignedIn() && isAdmin(condominiumId);
          allow list: if isSignedIn() && isAdmin(condominiumId);
          allow create: if isSignedIn() && isAdmin(condominiumId);
          allow update: if isSignedIn() && isAdmin(condominiumId);
          allow delete: if isSignedIn() && isAdmin(condominiumId);
      }

      match /suppliers/{supplierId} {
          allow get: if isSignedIn() && isAdmin(condominiumId);
          allow list: if isSignedIn() && isAdmin(condominiumId);
          allow create: if isSignedIn() && isAdmin(condominiumId);
          allow update: if isSignedIn() && isAdmin(condominiumId);
          allow delete: if isSignedIn() && isAdmin(condominiumId);
      }

      match /employees/{employeeId} {
          allow get: if isSignedIn() && isAdmin(condominiumId);
          allow list: if isSignedIn() && isAdmin(condominiumId);
          allow create: if isSignedIn() && isAdmin(condominiumId);
          allow update: if isSignedIn() && isAdmin(condominiumId);
          allow delete: if isSignedIn() && isAdmin(condominiumId);
      }

      match /communications/{communicationId} {
          allow get: if isSignedIn() && isAdmin(condominiumId);
          allow list: if isSignedIn() && isAdmin(condominiumId);
          allow create: if isSignedIn() && isAdmin(condominiumId);
          allow update: if isSignedIn() && isAdmin(condominiumId);
          allow delete: if isSignedIn() && isAdmin(condominiumId);
      }

      match /incidents/{incidentId} {
          allow get: if isSignedIn() && isAdmin(condominiumId);
          allow list: if isSignedIn() && isAdmin(condominiumId);
          allow create: if isSignedIn() && isAdmin(condominiumId);
          allow update: if isSignedIn() && isAdmin(condominiumId);
          allow delete: if isSignedIn() && isAdmin(condominiumId);
      }
    }
  }

  // Helper function to determine if a user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is an admin for the given condominium.
  // This is a placeholder, replace with your actual role checking logic.
  function isAdmin(condominiumId) {
    // TODO: Implement role checking logic (e.g., check a roles collection or a 'members' map on the condominium document).
    // For prototyping, we temporarily grant access to all signed-in users.
    return exists(/databases/$(database)/documents/condominiums/$(condominiumId)/admins/$(request.auth.uid));
  }
}